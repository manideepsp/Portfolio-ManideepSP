---
import BaseLayout from '../layouts/BaseLayout.astro';
import config from '../lib/config.json';
import ProjectCard from '../components/ProjectCard.astro';
import ExperienceTimeline from '../components/ExperienceTimeline.astro';
import ScrollRevealWrapper from '../components/ScrollRevealWrapper.astro';
import { fetchReadme } from '../lib/readmeFetcher';
import fs from 'fs';

let aboutHtml = '';
try {
  const md = fs.readFileSync(new URL('../../content/about.md', import.meta.url), 'utf8');
  aboutHtml = md.split('\n\n').map(p => `<p>${p.replace(/\n/g, ' ')}</p>`).join('');
} catch (e) {
  aboutHtml = '<p>No about content yet.</p>';
}

const repos = config.projectsRepoList || [];
const projects = await Promise.all(repos.map(async r => {
  const readme = await fetchReadme(r).catch(() => null);
  const excerpt = readme ? readme.split('\n').find(l => l.trim()) : 'No README available';
  const repoName = r.split('/').pop() || r;
  return { repo: r, excerpt, url: `https://github.com/${r}`, image: `/images/projects/${repoName}.png` };
}));
---
<BaseLayout title="Home">
  <section class="hero single-page">
    <p class="uppercase tracking-widest text-sm font-semibold" style="color: var(--accent);">Software Engineer</p>
    <h1 class="text-5xl font-bold leading-tight">{config.name}</h1>
    <p class="text-lg" style="color: var(--muted);">{config.title}</p>
    <p class="text-lg" style="color: var(--muted); font-weight: 400;">I build data & ML systems that scale. Currently shipping backend services and production ML pipelines at scale.</p>
    <div class="ctas">
      <a class="btn primary" href={`https://github.com/${config.githubUsername}`} target="_blank">GitHub</a>
      <a class="btn ghost" href={`/resumes/${config.resume}`} target="_blank">Download Resume</a>
    </div>
  </section>

  <section class="single-page about-block">
    <h2>About</h2>
    <div class="markdown-render" innerHTML={aboutHtml}></div>
  </section>

  <section class="single-page split-layout">
    <div class="projects-column">
      <h2>Projects</h2>
      <div class="projects-list">
        {projects.map((p, i) => (
          <ScrollRevealWrapper delay={i * 80}>
            <ProjectCard repo={p.repo} excerpt={p.excerpt} url={p.url} />
          </ScrollRevealWrapper>
        ))}
      </div>
    </div>
    <div class="timeline-column timeline-right">
      <h2>Experience</h2>
      <ExperienceTimeline />
    </div>
  </section>
</BaseLayout>
