---
import BaseLayout from '../layouts/BaseLayout.astro';
import config from '../lib/config.json';
---
<BaseLayout title="Contact">
  <section>
    <h1>Contact</h1>
    <div class="contact-icons" role="group" aria-label="Contact methods">
      <div class="email-card" role="group" aria-label="Email card">
        <div class="email-text">{config.social.email}</div>
        <div class="email-actions">
          <button id="emailOpenBtn" class="contact-icon small" title="Open email" aria-label="Open email" type="button" data-email={config.social.email} data-tooltip="Open email">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><polyline points="22,6 12,13 2,6"/></svg>
          </button>
          <button id="copyEmailBtn" class="contact-icon small" title="Copy email" aria-label="Copy email" type="button" data-email={config.social.email} data-tooltip="Copy email">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
          </button>
        </div>
      </div>
      <a href={`https://linkedin.com/in/${config.social.linkedin}`} class="contact-icon" title="LinkedIn" aria-label="LinkedIn" target="_blank" rel="noopener" data-tooltip="LinkedIn profile">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="4"/><line x1="7" y1="10" x2="7" y2="16"/><line x1="7" y1="7" x2="7" y2="7"/><line x1="11" y1="16" x2="11" y2="10"/><path d="M11 13a2 2 0 0 1 4 0v3"/></svg>
      </a>
      <a href={`https://github.com/${config.social.github}`} class="contact-icon" title="GitHub" aria-label="GitHub" target="_blank" rel="noopener" data-tooltip="GitHub profile">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.48 2 2 6.58 2 12.26c0 4.49 2.87 8.3 6.84 9.64.5.09.68-.22.68-.48 0-.24-.01-.87-.01-1.7-2.78.62-3.37-1.36-3.37-1.36-.45-1.18-1.1-1.5-1.1-1.5-.9-.63.07-.62.07-.62 1 .07 1.53 1.05 1.53 1.05.89 1.56 2.34 1.11 2.91.85.09-.66.35-1.11.63-1.37-2.22-.26-4.56-1.14-4.56-5.07 0-1.12.39-2.03 1.03-2.75-.1-.26-.45-1.3.1-2.7 0 0 .84-.28 2.75 1.05A9.38 9.38 0 0 1 12 6.8c.85.004 1.71.12 2.51.35 1.91-1.33 2.75-1.05 2.75-1.05.55 1.4.2 2.44.1 2.7.64.72 1.03 1.63 1.03 2.75 0 3.94-2.34 4.81-4.57 5.07.36.32.68.94.68 1.9 0 1.37-.01 2.47-.01 2.81 0 .27.18.58.69.48A10.01 10.01 0 0 0 22 12.26C22 6.58 17.52 2 12 2z"/></svg>
      </a>
    </div>

      <form id="contactForm" class="contact-form modern-contact-form">
      <div class="modern-form-grid">
        <div class="modern-form-col">
          <label class="modern-form-label form-field">
            <div class="label-head">Name <span class="required-asterisk">*</span></div>
            <input class="modern-form-input form-input" name="name" required placeholder="Your full name" aria-required="true" />
            <div class="field-error" aria-live="polite"></div>
          </label>
          <label class="modern-form-label form-field">
            <div class="label-head">Email <span class="required-asterisk">*</span></div>
            <input class="modern-form-input form-input" name="email" type="email" required placeholder="you@company.com" aria-required="true" />
            <div class="field-error" aria-live="polite"></div>
            <div id="emailSuggestion" class="email-suggestion" aria-live="polite"></div>
          </label>
          <label class="modern-form-label form-field">
            <div class="label-head">Position</div>
            <input class="modern-form-input form-input" name="position" placeholder="Role or company (optional)" />
            <div class="field-error" aria-live="polite"></div>
          </label>
        </div>
        <div class="modern-form-col">
          <label class="modern-form-label form-field">
            <div class="label-head">Message <span class="required-asterisk">*</span></div>
            <textarea class="modern-form-textarea form-textarea" name="message" required placeholder="Tell me about your project or opportunity" aria-required="true"></textarea>
            <div class="field-error" aria-live="polite"></div>
            <div id="messageCounter" class="char-counter" aria-live="polite">
              <span class="char-current">0</span>
              <span class="char-sep">/</span>
              <span class="char-min">100</span>
              <span class="char-label">min</span>
            </div>
          </label>
        </div>
      </div>
      <div class="modern-form-actions">
        <button type="submit" class="modern-btn primary" id="submitBtn">
          <span id="btnText">Send Message</span>
          <svg class="btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M22 2L11 13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          <svg class="btn-spinner" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-dasharray="31.4" stroke-dashoffset="10"/></svg>
        </button>
        <a id="fallbackBtn" class="modern-btn ghost" style="display:none" target="_blank" rel="noopener">Open GitHub fallback</a>
      </div>
      <div id="formMessage" class="form-message" role="status" aria-live="polite"></div>
    </form>

    <style>
      .contact-icons { display:flex; gap:16px; margin-bottom:28px; align-items:center }
      .contact-icon { display:flex; align-items:center; justify-content:center; width:44px; height:44px; border-radius:10px; background:var(--surface,#0f1622); color:var(--accent,#4f8cff); border:1px solid rgba(255,255,255,0.03); cursor:pointer }
      .contact-icon.small { width:34px; height:34px; border-radius:8px }
      .contact-icon svg { display:block }
      .contact-icon:hover { background:var(--accent,#4f8cff); color:#fff }
      /* Email card sizes to content (no hard-coded width). Email left, icons right. */
      .email-card{ display:inline-flex; align-items:center; gap:12px; padding:10px 12px; border-radius:10px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); max-width:100%; flex:0 0 auto; justify-content:flex-start }
      .email-text{ color:var(--text); font-weight:600; font-size:0.95rem; white-space:nowrap; margin-right:8px; text-align:left }
      .email-actions{ display:flex; gap:8px; align-items:center }
      /* copy-feedback element removed; copy action uses toast popup */
      .modern-contact-form{ background:var(--surface,#0f1622); padding:24px; border-radius:12px; max-width:820px; box-shadow:0 6px 30px rgba(0,0,0,0.35) }
    
      /* Minimal modern tooltips for contact icons */
      .contact-icon{ position:relative; display:inline-flex; align-items:center; justify-content:center; }
      .contact-icon[data-tooltip]::after{
        content: attr(data-tooltip);
        position:absolute;
        bottom:calc(100% + 8px);
        left:50%;
        transform:translateX(-50%);
        background:var(--bg-accent-dark, rgba(16,18,20,0.9));
        color:var(--text-on-accent, #fff);
        padding:6px 8px;
        border-radius:8px;
        font-size:12px;
        white-space:nowrap;
        opacity:0;
        pointer-events:none;
        transition:opacity .12s ease, transform .12s ease;
        box-shadow:0 6px 18px rgba(12,14,20,0.28);
        z-index:30;
      }
      .contact-icon[data-tooltip]::before{
        content: '';
        position: absolute;
        bottom: calc(100% + 3px);
        left:50%;
        transform: translateX(-50%);
        border-width:6px 6px 0 6px;
        border-style:solid;
        border-color: var(--bg-accent-dark, rgba(16,18,20,0.9)) transparent transparent transparent;
        opacity:0;
        pointer-events:none;
        transition:opacity .12s ease;
        z-index:30;
      }
      .contact-icon[data-tooltip]:hover::after,
      .contact-icon[data-tooltip]:focus::after,
      .contact-icon[data-tooltip]:active::after{
        opacity:1;
        transform:translateX(-50%) translateY(-4px);
      }
      .contact-icon[data-tooltip]:hover::before,
      .contact-icon[data-tooltip]:focus::before,
      .contact-icon[data-tooltip]:active::before{
        opacity:1;
      }
      /* Ensure keyboard focus shows tooltip */
      .contact-icon:focus{ outline: none; }
      .contact-icon:focus-visible{ box-shadow:0 0 0 3px rgba(59,130,246,0.15); border-radius:6px; }
      .modern-form-grid{ display:flex; gap:24px; flex-wrap:wrap }
      .modern-form-col{ flex:1 1 260px }
      .modern-form-label{ display:flex; flex-direction:column; gap:8px; color:var(--text) }
      .modern-form-label .label-head{ display:flex; align-items:center; gap:8px; font-weight:600 }
      .modern-form-label .required-asterisk{ color:var(--accent,#4f8cff); margin-left:2px; font-weight:800 }
      /* Invalid field styling + shake animation */
      .form-input.invalid, .form-textarea.invalid{ border-color: var(--error,#ef4444); box-shadow: 0 6px 18px rgba(239,68,68,0.08); }
      .flash-red{ box-shadow: 0 0 0 4px rgba(239,68,68,0.08); }
      .shake{ animation: shake 0.9s cubic-bezier(.36,.07,.19,.97); }
      @keyframes shake {
        10%, 90% { transform: translateX(-1px); }
        20%, 80% { transform: translateX(2px); }
        30%, 50%, 70% { transform: translateX(-4px); }
        40%, 60% { transform: translateX(4px); }
      }
      .modern-form-input, .modern-form-textarea{ padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:var(--background,#0b0e13); color:var(--text); min-height:40px }
      .modern-form-textarea{ min-height:140px }
      .modern-form-actions{ margin-top:20px; display:flex; gap:12px }
      .modern-btn{ 
        padding:12px 24px; 
        border-radius:10px; 
        font-weight:700;
        font-size:0.95rem;
        display:inline-flex;
        align-items:center;
        gap:10px;
        cursor:pointer;
        transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
        border:none;
        position:relative;
      }
      .modern-btn.primary{
        background:linear-gradient(135deg, var(--accent,#1fb6a0) 0%, var(--accent-2,#2dd4bf) 100%);
        color:#fff;
        box-shadow:0 4px 14px rgba(31,182,160,0.25);
      }
      .modern-btn.primary:hover{
        transform:translateY(-2px);
        box-shadow:0 6px 20px rgba(31,182,160,0.35);
      }
      .modern-btn.primary:active{ transform:translateY(0) }
      .modern-btn.primary:disabled{
        opacity:0.7;
        cursor:not-allowed;
        transform:none;
      }
      .modern-btn .btn-icon{ transition:opacity 0.2s ease }
      .modern-btn .btn-spinner{
        display:none;
        animation:spin 1s linear infinite;
      }
      .modern-btn.loading .btn-icon{ display:none }
      .modern-btn.loading .btn-spinner{ display:block }
      @keyframes spin{ from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
      .modern-btn.ghost{
        background:transparent;
        color:var(--accent,#1fb6a0);
        border:1px solid var(--accent,#1fb6a0);
      }
      .modern-btn.ghost:hover{
        background:rgba(31,182,160,0.1);
      }
      /* Form message styling */
      .form-message{
        margin-top:16px;
        padding:12px 16px;
        border-radius:8px;
        font-size:0.9rem;
        display:none;
      }
      .form-message:not(:empty){ display:block }
      .form-message.info{
        background:rgba(59,130,246,0.1);
        border:1px solid rgba(59,130,246,0.2);
        color:#60a5fa;
      }
      .form-message.success{
        background:rgba(34,197,94,0.1);
        border:1px solid rgba(34,197,94,0.2);
        color:#22c55e;
      }
      .form-message.error{
        background:rgba(239,68,68,0.1);
        border:1px solid rgba(239,68,68,0.2);
        color:#ef4444;
      }
      /* Email suggestion styling */
      .email-suggestion{
        display:none;
        margin-top:8px;
        font-size:0.85rem;
        color:var(--muted);
      }
      .email-suggest-btn{
        background:none;
        border:none;
        color:var(--accent,#1fb6a0);
        cursor:pointer;
        font-weight:600;
        text-decoration:underline;
        text-underline-offset:2px;
        padding:0;
      }
      .email-suggest-btn:hover{ color:var(--accent-2,#2dd4bf) }
      /* Field error styling */
      .field-error{
        color:var(--error,#ef4444);
        font-size:0.8rem;
        min-height:1.2em;
        margin-top:4px;
      }
      @media(max-width:720px){ .modern-form-grid{ flex-direction:column } }
      /* Character counter styling */
      .char-counter{
        display:inline-flex;
        align-items:baseline;
        gap:4px;
        padding:6px 10px;
        border-radius:6px;
        font-size:0.8rem;
        font-weight:600;
        margin-top:8px;
        background:rgba(239,68,68,0.1);
        border:1px solid rgba(239,68,68,0.2);
        transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      }
      .char-counter .char-current{
        font-size:0.95rem;
        font-weight:700;
        color:var(--error,#ef4444);
        min-width:2ch;
        text-align:right;
        transition:color 0.3s ease;
      }
      .char-counter .char-sep{ color:var(--muted); opacity:0.6 }
      .char-counter .char-min{ color:var(--muted); font-weight:500 }
      .char-counter .char-label{
        font-size:0.7rem;
        text-transform:uppercase;
        letter-spacing:0.04em;
        color:var(--muted);
        opacity:0.7;
        margin-left:2px;
      }
      .char-counter.low{
        background:rgba(239,68,68,0.1);
        border-color:rgba(239,68,68,0.25);
      }
      .char-counter.low .char-current{ color:var(--error,#ef4444) }
      .char-counter.ok{
        background:rgba(34,197,94,0.1);
        border-color:rgba(34,197,94,0.25);
      }
      .char-counter.ok .char-current{ color:#22c55e }
      .char-counter.ok .char-label{ display:none }
      /* Small-screen: truncate long emails with ellipsis and let card fill available width */
      @media (max-width:480px) {
        .email-card{ display:flex; width:100%; box-sizing:border-box; }
        .email-text{ max-width: calc(100% - 88px); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .email-actions .contact-icon.small{ width:30px; height:30px }
      }
    </style>
  </section>
    <script type="module" define:vars={{ workerUrl: config.contactWorkerUrl ?? '', fallbackConfig: config.contactFallback ?? {}, siteEmail: config.social.email, siteOwner: config.social.github }}>
      // Dynamically load shared toast helper from the public path that includes the site's base.
      let _sharedToastModule = null;
      async function ensureSharedToast() {
        if (_sharedToastModule) return _sharedToastModule;
        // Determine base from <base href> if present, otherwise use the pathname root (GitHub Pages style)
        const baseEl = document.querySelector('base');
        let base = baseEl ? baseEl.getAttribute('href') || '/' : '/';
        // If base is just '/', attempt to infer from the first path segment (when deployed under repo path)
        if (!base || base === '/') {
          const seg = window.location.pathname.split('/').filter(Boolean)[0];
          if (seg) base = `/${seg}/`;
        }
        if (!base.endsWith('/')) base = base + '/';
        const path = `${base}lib/toast.js`;
        try {
          _sharedToastModule = await import(path);
        } catch (err) {
          // Fallback to absolute /lib if dynamic import fails
          try { _sharedToastModule = await import('/lib/toast.js'); } catch (e) { console.error('Failed to load toast helper', err, e); _sharedToastModule = null; }
        }
        return _sharedToastModule;
      }
      const form = document.getElementById('contactForm');

      function makePrefillIssueUrl({ owner, repo, name, email, position, message }) {
        const title = encodeURIComponent(`[Portfolio Contact] ${name} — ${email}`);
        const body = encodeURIComponent(`**Name:** ${name}\n**Email:** ${email}\n**Position:** ${position}\n\n---\n\n${message}`);
        return `https://github.com/${owner}/${repo}/issues/new?title=${title}&body=${body}`;
      }

      async function submitToWorker(payload) {
        if (!workerUrl) return { ok: false, reason: 'no-worker' };
        try {
          const res = await fetch(workerUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          try { return await res.json(); } catch(e) { return { ok: res.ok }; }
        } catch (err) {
          return { ok: false, reason: err.message };
        }
      }

      const submitBtn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      const messageEl = document.getElementById('formMessage');
      const emailInput = form.elements['email'];
      const emailSuggestionEl = document.getElementById('emailSuggestion');

      // Email action buttons: open mail client and copy to clipboard
      const emailOpenBtn = document.getElementById('emailOpenBtn');
      const copyEmailBtn = document.getElementById('copyEmailBtn');
      const configuredEmail = (typeof siteEmail !== 'undefined' && siteEmail) ? siteEmail : (emailInput ? emailInput.value : '');
      if (emailOpenBtn) {
        emailOpenBtn.addEventListener('click', () => {
          try { window.location.href = `mailto:${configuredEmail}`; } catch (e) { /* ignore */ }
        });
      }
      if (copyEmailBtn) {
        copyEmailBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(configuredEmail);
            // show a popup toast confirmation instead of inline element
            try { ensureSharedToast().then(m => m && m.showToast('success', 'Email copied to clipboard')); } catch (e) { /* ignore */ }
          } catch (err) {
            try { showMessage('Could not copy email to clipboard', 'error'); } catch (e) { alert('Could not copy email'); }
          }
        });
      }

      // Debounce helper
      function debounce(fn, wait) {
        let t = null;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      }

      // Simple Levenshtein distance for domain suggestion
      function levenshtein(a, b) {
        const dp = Array.from({ length: a.length + 1 }, () => new Array(b.length + 1).fill(0));
        for (let i = 0; i <= a.length; i++) dp[i][0] = i;
        for (let j = 0; j <= b.length; j++) dp[0][j] = j;
        for (let i = 1; i <= a.length; i++) {
          for (let j = 1; j <= b.length; j++) {
            const cost = a[i - 1] === b[j - 1] ? 0 : 1;
            dp[i][j] = Math.min(dp[i - 1][j] + 1, dp[i][j - 1] + 1, dp[i - 1][j - 1] + cost);
          }
        }
        return dp[a.length][b.length];
      }

      const commonDomains = ['gmail.com','hotmail.com','yahoo.com','outlook.com','icloud.com','protonmail.com','proton.me','live.com','aol.com','gmx.com','yahoo.co.uk','hotmail.co.uk'];

      function suggestEmailCorrection(value) {
        if (!value || value.indexOf('@') === -1) return null;
        const parts = value.split('@');
        if (parts.length !== 2) return null;
        const local = parts[0];
        const domain = parts[1].toLowerCase();
        // If domain exactly matches a known one, no suggestion
        if (commonDomains.includes(domain)) return null;

        // Find nearest domain
        let best = null; let bestDist = Infinity;
        for (const d of commonDomains) {
          const dist = levenshtein(domain, d);
          if (dist < bestDist) { bestDist = dist; best = d; }
        }
        // Only suggest if reasonably small edit distance
        if (best && bestDist > 0 && bestDist <= 2) {
          return `${local}@${best}`;
        }
        return null;
      }

      function showEmailSuggestion(suggestion) {
        if (!suggestion) {
          emailSuggestionEl.textContent = '';
          emailSuggestionEl.style.display = 'none';
          emailInput.removeAttribute('aria-describedby');
          return;
        }
        emailSuggestionEl.innerHTML = `Did you mean <button type="button" class="email-suggest-btn">${suggestion}</button>?`;
        emailSuggestionEl.style.display = 'block';
        const btn = emailSuggestionEl.querySelector('.email-suggest-btn');
        if (btn) {
          btn.addEventListener('click', () => {
            emailInput.value = suggestion;
            emailInput.focus();
            showEmailSuggestion(null);
            clearFieldErrors();
          });
        }
        // link suggestion for screen readers
        emailInput.setAttribute('aria-describedby', 'emailSuggestion');
      }

      const debouncedSuggest = debounce(() => {
        try {
          const val = (emailInput && emailInput.value) ? emailInput.value.trim() : '';
          const s = suggestEmailCorrection(val);
          showEmailSuggestion(s);
        } catch (e) { /* ignore */ }
      }, 400);

      // validate on blur and provide real-time suggestion on input
      if (emailInput) {
        emailInput.addEventListener('input', () => {
          // clear field error while typing
          const wrap = emailInput.closest('.form-field');
          if (wrap) {
            const err = wrap.querySelector('.field-error'); if (err) err.textContent = '';
          }
          emailInput.classList.remove('invalid');
          emailInput.removeAttribute('aria-invalid');
          emailInput.removeAttribute('aria-describedby');
          debouncedSuggest();
        });

        emailInput.addEventListener('blur', () => {
          // run quick validation on blur
          const val = (emailInput.value || '').trim();
          if (!val) {
            setFieldError(emailInput, 'Please enter your email address.');
          } else if (!validateEmail(val)) {
            setFieldError(emailInput, 'Please enter a valid email address.');
          }
        });
      }

      // add blur validation for all fields
      form.querySelectorAll('.form-input, .form-textarea').forEach(el => {
        el.addEventListener('blur', () => {
          const v = (el.value || '').trim();
          if (el.required && !v) {
            setFieldError(el, 'This field is required.');
          } else if (el.type === 'email' && v && !validateEmail(v)) {
            setFieldError(el, 'Please enter a valid email address.');
          } else if (el.tagName.toLowerCase() === 'textarea' && v && v.length < 100) {
            setFieldError(el, 'Message must be at least 100 characters.');
          }
        });
      });

      // Message character counter behavior
      const messageInput = form.elements['message'];
      const messageCounter = document.getElementById('messageCounter');
      function updateMessageCounter() {
        if (!messageInput || !messageCounter) return;
        const len = (messageInput.value || '').length;
        const currentEl = messageCounter.querySelector('.char-current');
        if (currentEl) currentEl.textContent = len;
        if (len >= 100) {
          messageCounter.classList.remove('low');
          messageCounter.classList.add('ok');
          // clear any message-related field error when length requirement met
          const wrap = messageInput.closest('.form-field');
          if (wrap) {
            const err = wrap.querySelector('.field-error'); if (err) err.textContent = '';
          }
          messageInput.classList.remove('invalid');
          messageInput.removeAttribute('aria-invalid');
        } else {
          messageCounter.classList.remove('ok');
          messageCounter.classList.add('low');
        }
      }

      if (messageInput) {
        // update immediately and on input
        updateMessageCounter();
        messageInput.addEventListener('input', () => {
          updateMessageCounter();
        });
      }

      function clearFieldErrors() {
        form.querySelectorAll('.field-error').forEach(el => el.textContent = '');
        form.querySelectorAll('.form-input, .form-textarea').forEach(el => {
          el.classList.remove('invalid');
          el.removeAttribute('aria-invalid');
          el.removeAttribute('aria-describedby');
        });
      }

      function setFieldError(input, msg) {
        const wrap = input.closest('.form-field');
        if (wrap) {
          const err = wrap.querySelector('.field-error');
          if (err) {
            // Ensure an id exists so we can reference it from aria-describedby
            if (!err.id) err.id = `${input.name}-error`;
            err.textContent = msg;
            input.setAttribute('aria-describedby', err.id);
          }
        }
        input.classList.add('invalid');
        input.setAttribute('aria-invalid', 'true');
        // Add temporary visual emphasis: shake + flash-red for 1s
        input.classList.remove('shake');
        input.classList.remove('flash-red');
        // Force reflow so animation restarts reliably
        // eslint-disable-next-line no-unused-expressions
        void input.offsetWidth;
        input.classList.add('shake');
        input.classList.add('flash-red');
        setTimeout(() => {
          input.classList.remove('shake');
          input.classList.remove('flash-red');
        }, 1000);
      }

      function validateEmail(email) {
        if (!email || typeof email !== 'string') return false;
        const v = email.trim();
        // Strict email validation: RFC-like but practical
        // Local part allows most common characters, domain enforces labels and TLD >=2
        const strictEmailRe = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?(?:\.[A-Za-z]{2,})+$/;
        return strictEmailRe.test(v);
      }

      function validateForm() {
        clearFieldErrors();
        const errors = [];
        const inputs = Array.from(form.querySelectorAll('.form-input, .form-textarea'));

        for (const input of inputs) {
          // Trim whitespace for validation purposes
          const val = input.value != null ? String(input.value).trim() : '';
          // temporarily set trimmed value for validity checks
          const original = input.value;
          input.value = val;

          // Use constraint validation API
          if (!input.checkValidity()) {
            // Use validationMessage when available, otherwise fallback
            const msg = input.validationMessage || 'Please complete this field.';
            setFieldError(input, msg);
            errors.push(input);
          }

          // restore original (in case of textarea with leading/trailing whitespace intended)
          input.value = original;
        }

        // Additional custom check for email format (safeguard)
        const email = form.elements['email'];
        if (email && email.value && !validateEmail(email.value.trim())) {
          setFieldError(email, 'Please enter a valid email address.');
          if (!errors.includes(email)) errors.push(email);
        }

        return errors;
      }

      function setLoading(loading) {
        if (loading) {
          submitBtn.disabled = true;
          submitBtn.classList.add('loading');
          btnText.textContent = 'Sending…';
          submitBtn.setAttribute('aria-busy', 'true');
        } else {
          submitBtn.disabled = false;
          submitBtn.classList.remove('loading');
          btnText.textContent = 'Send Message';
          submitBtn.removeAttribute('aria-busy');
        }
      }

      const fallbackBtn = document.getElementById('fallbackBtn');

      let redirectTimer = null;

      function showMessage(text, type = 'info', fallbackUrl, autoRedirect = false) {
        // clear any pending redirect
        if (redirectTimer) {
          clearTimeout(redirectTimer);
          redirectTimer = null;
        }

        messageEl.textContent = text;
        messageEl.className = `form-message ${type}`;
        if (fallbackUrl && fallbackConfig.showFallbackButton !== false) {
          fallbackBtn.href = fallbackUrl;
          fallbackBtn.style.display = 'inline-block';
        } else {
          fallbackBtn.style.display = 'none';
          fallbackBtn.removeAttribute('href');
        }

        const delay = Number(fallbackConfig.delayMs) || 5000;
        if (fallbackUrl && autoRedirect && fallbackConfig.autoRedirect !== false) {
          // after configured delay open fallback in a new tab so user sees the explanation
          redirectTimer = setTimeout(() => {
            try { window.open(fallbackUrl, '_blank'); } catch (e) { /* ignore */ }
            redirectTimer = null;
          }, delay);
        }
      }

      // `showToast` is provided by the shared helper imported at the top of this module

      form.addEventListener('submit', async e => {
        e.preventDefault();
        const fd = new FormData(form);
        const payload = Object.fromEntries(fd.entries());
        const repoName = fallbackConfig.repo || 'Portfolio-ManideepSP';
        const post = {
          owner: (typeof siteOwner !== 'undefined' && siteOwner) ? siteOwner : '${config.social.github}',
          repo: repoName,
          title: `[Portfolio Contact] ${payload.name} — ${payload.email}`,
          name: payload.name,
          email: payload.email,
          position: payload.position,
          message: payload.message
        };
        // Client-side validation
        const validationErrors = validateForm();
        if (validationErrors.length) {
          // show native browser validation UI and focus first invalid field
          try { form.reportValidity(); } catch (e) { /* ignore */ }
          validationErrors[0].focus();
          showMessage('Please fix the highlighted fields and try again.', 'error');
          try { ensureSharedToast().then(m => m && m.showToast('error', 'Please fix the highlighted fields and try again.')); } catch (e) { /* ignore */ }
          return;
        }

        // Final safeguard: normalize payload and re-check required fields before sending
        post.name = post.name ? String(post.name).trim() : '';
        post.email = post.email ? String(post.email).trim() : '';
        post.message = post.message ? String(post.message).trim() : '';

        if (!post.name) {
          const first = form.elements['name']; setFieldError(first, 'Please enter your name.'); first.focus(); showMessage('Please fix the highlighted fields and try again.', 'error'); try { ensureSharedToast().then(m => m && m.showToast('error', 'Please enter your name.')); } catch (e) { /* ignore */ } return;
        }
        if (!post.email || !validateEmail(post.email)) {
          const first = form.elements['email']; setFieldError(first, 'Please enter a valid email address.'); first.focus(); showMessage('Please fix the highlighted fields and try again.', 'error'); try { ensureSharedToast().then(m => m && m.showToast('error', 'Please enter a valid email address.')); } catch (e) { /* ignore */ } return;
        }
        if (!post.message || post.message.length < 100) {
          const first = form.elements['message']; setFieldError(first, 'Message must be at least 100 characters.'); first.focus(); showMessage('Please fix the highlighted fields and try again.', 'error'); try { ensureSharedToast().then(m => m && m.showToast('error', 'Message must be at least 100 characters.')); } catch (e) { /* ignore */ } return;
        }

        // Try secure Worker proxy first
        setLoading(true);
        showMessage('Sending message...', 'info');
        const resp = await submitToWorker(post);
        if (resp && resp.ok) {
          showMessage('Message sent — thank you!', 'success');
          try { ensureSharedToast().then(m => m && m.showToast('success', 'Message sent — thank you!')); } catch (e) { /* ignore */ }
          form.reset();
          clearFieldErrors();
          updateMessageCounter(); // Reset character counter
          setLoading(false);
          return;
        }

        // Fallback: offer prefilled GitHub issue (requires user to sign in)
        setLoading(false);
        const fallbackUrl = makePrefillIssueUrl({ owner: post.owner, repo: post.repo, ...post });
        const seconds = Math.round((Number(fallbackConfig.delayMs) || 5000) / 1000);
        showMessage(
          `Could not send via secure proxy. You will be redirected to GitHub in ${seconds} seconds — please make sure you are signed in to GitHub to submit the issue.`,
          'error',
          fallbackUrl,
          true
        );
        try { ensureSharedToast().then(m => m && m.showToast('error', 'Could not send via secure proxy. Redirecting to fallback.')); } catch (e) { /* ignore */ }
      });
    </script>
</BaseLayout>
