---
import { experience as expConfig } from '../lib/config.js';

interface ExperienceEntry {
  title: string;
  company: string;
  companyLink?: string;
  date: string;
  displayDate: string;
  description: string;
  skills: string[];
}

// Read experience from config
const rawExperience = expConfig.entries || [];
const settings = expConfig.settings || { showMonth: true, dateFormat: 'short', companyAccent: '#1fb6a0' };
const companyAccent = settings.companyAccent || '#1fb6a0';

const entries: ExperienceEntry[] = rawExperience.map((exp: any) => {
  let displayDate = exp.date;
  
  // Parse date and format for display
  if (exp.date) {
    if (/^\d{4}-\d{2}$/.test(exp.date)) {
      const d = new Date(exp.date + '-01');
      if (!isNaN(d.getTime())) {
        displayDate = settings.showMonth 
          ? d.toLocaleString('en', { month: 'short', year: 'numeric' })
          : d.getFullYear().toString();
      }
    } else if (/^\d{4}$/.test(exp.date)) {
      displayDate = settings.showMonth ? `Jan ${exp.date}` : exp.date;
    }
  }

  return {
    title: exp.title,
    company: exp.company,
    companyLink: exp.companyLink,
    date: exp.date,
    displayDate,
    description: exp.description,
    skills: exp.skills || []
  };
});

// Sort by date descending (most recent first)
entries.sort((a, b) => {
  const parseDate = (d: string) => {
    if (/^\d{4}-\d{2}$/.test(d)) return new Date(d + '-01').getTime();
    if (/^\d{4}$/.test(d)) return new Date(`${d}-01-01`).getTime();
    return 0;
  };
  return parseDate(b.date) - parseDate(a.date);
});

// Group entries by company to allow multiple projects under one company
const map = new Map<string, { company: string; companyLink?: string; projects: ExperienceEntry[] }>();
for (const e of entries) {
  const key = e.company || 'Independent';
  if (!map.has(key)) {
    map.set(key, { company: e.company, companyLink: e.companyLink, projects: [] });
  }
  map.get(key)!.projects.push(e);
}

const groups = Array.from(map.values());

---

<div class="timeline experience-timeline">
  {groups.map((group, gidx) => (
    <section class="company-block" key={`company-${gidx}`}>
      <header class="company-header">
        {group.companyLink ? (
          <a class="company-link" href={group.companyLink} target="_blank" rel="noopener noreferrer" style={`color: ${companyAccent}; font-weight: 700;`}>
            {group.company}
          </a>
        ) : (
          <div class="company-name" style={`color: ${companyAccent}; font-weight: 700;`}>
            {group.company}
          </div>
        )}
      </header>

      <div class="company-projects">
        {group.projects.map((entry, idx) => (
          <article class="project-item" data-sr style={`--delay: ${idx * 80}ms`}>
            <div class="project-header">
              <h4 class="project-title">{entry.title}</h4>
              <div class="project-date">{entry.displayDate}</div>
            </div>
            {entry.description && <p class="project-desc">{entry.description}</p>}
            <div class="project-meta">
              {entry.skills.map(s => (<span class="tech-tag">{s}</span>))}
            </div>
          </article>
        ))}
      </div>
    </section>
  ))}
</div>

<style>
  .experience-timeline {
    position: relative;
    padding: 20px 16px 20px 16px;
  }

  /* Remove the central connecting line and the per-item bullets */
  .experience-timeline::before,
  .experience-item::before {
    display: none;
  }

  .experience-item {
    animation: slideIn 0.6s ease-out forwards;
    animation-delay: var(--delay, 0ms);
    opacity: 0;
    display: block;
    margin-bottom: 24px;
  }

  .experience-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 16px;
  }

  .company {
    margin-left: 8px;
    /* color and font-weight set inline for config-driven accent */
  }

  .experience-date {
    color: var(--muted);
    font-size: 13px;
    font-family: var(--font-mono);
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Company grouping and project styling */
  .company-block {
    margin-bottom: 28px;
  }
  .company-header {
    margin-bottom: 10px;
  }
  .company-link, .company-name {
    font-size: 1.05rem;
    letter-spacing: -0.01em;
  }

  .company-projects {
    margin-left: 14px; /* slight indent for projects */
    border-left: 2px solid rgba(255,255,255,0.03);
    padding-left: 16px;
  }

  .project-item {
    margin-bottom: 14px;
    padding-left: 6px;
  }

  .project-header {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: baseline;
  }

  .project-title {
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
  }

  .project-date {
    color: var(--muted);
    font-family: var(--font-mono);
    font-size: 12px;
  }

  .project-desc {
    color: var(--muted);
    margin-top: 6px;
    margin-bottom: 6px;
    font-size: 0.95rem;
  }

  .project-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
</style>
