---
import config from '../lib/config.json';

interface ExperienceEntry {
  title: string;
  company: string;
  date: string;
  displayDate: string;
  description: string;
  skills: string[];
}

// Read experience from config JSON
const rawExperience = config.experience || [];
const settings = config.experienceSettings || { showMonth: true, dateFormat: 'short' };

const entries: ExperienceEntry[] = rawExperience.map((exp: any) => {
  let displayDate = exp.date;
  
  // Parse date and format for display
  if (exp.date) {
    // Handle YYYY-MM format
    if (/^\d{4}-\d{2}$/.test(exp.date)) {
      const d = new Date(exp.date + '-01');
      if (!isNaN(d.getTime())) {
        displayDate = settings.showMonth 
          ? d.toLocaleString('en', { month: 'short', year: 'numeric' })
          : d.getFullYear().toString();
      }
    } 
    // Handle YYYY format
    else if (/^\d{4}$/.test(exp.date)) {
      displayDate = settings.showMonth ? `Jan ${exp.date}` : exp.date;
    }
  }

  return {
    title: exp.title,
    company: exp.company,
    date: exp.date,
    displayDate,
    description: exp.description,
    skills: exp.skills || []
  };
});

// Sort by date descending (most recent first)
entries.sort((a, b) => {
  const parseDate = (d: string) => {
    if (/^\d{4}-\d{2}$/.test(d)) return new Date(d + '-01').getTime();
    if (/^\d{4}$/.test(d)) return new Date(`${d}-01-01`).getTime();
    return 0;
  };
  return parseDate(b.date) - parseDate(a.date);
});
---

<div class="timeline experience-timeline timeline-modern">
  {entries.map((entry, idx) => (
    <div class="experience-item experience-card" data-sr style={`--delay: ${idx * 100}ms`}>
      <div class="timeline-dot"></div>
      <div class="experience-content">
        <div class="experience-header">
          <h3 class="text-lg font-semibold">
            {entry.title}
            <span class="company">@ {entry.company}</span>
          </h3>
          <div class="experience-date">{entry.displayDate}</div>
        </div>
        {entry.description && <p class="text-sm exp-desc">{entry.description}</p>}
        <div class="experience-meta">
          {entry.skills.map(t => (
            <span class="tech-tag">{t}</span>
          ))}
        </div>
      </div>
    </div>
  ))}
</div>

<style>
  .timeline-modern {
    position: relative;
    padding: 20px 0 20px 0;
    margin-left: 18px;
  }

  .timeline-modern::before {
    content: '';
    position: absolute;
    left: 18px;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(180deg, var(--accent), rgba(45,212,191,0.12) 80%, transparent 100%);
    border-radius: 2px;
    z-index: 0;
  }

  .experience-item {
    position: relative;
    display: flex;
    align-items: flex-start;
    margin-bottom: 44px;
    animation: slideIn 0.6s ease-out forwards;
    animation-delay: var(--delay, 0ms);
    opacity: 0;
  }

  .timeline-dot {
    position: absolute;
    left: -18px;
    top: 32px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--bg);
    border: 3px solid var(--accent);
    box-shadow: 0 0 0 6px rgba(45,212,191,0.10);
    z-index: 2;
    transition: box-shadow 0.2s;
  }
  .experience-item:hover .timeline-dot {
    box-shadow: 0 0 0 12px rgba(45,212,191,0.18);
  }

  .experience-card {
    background: rgba(15, 23, 42, 0.82);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(45,212,191,0.08), 0 2px 12px rgba(99,102,241,0.06);
    border: 1.5px solid rgba(148, 163, 184, 0.13);
    padding: 32px 32px 24px 48px;
    margin-left: 18px;
    width: 100%;
    transition: box-shadow 0.18s, border-color 0.18s;
  }
  .experience-card:hover {
    border-color: var(--accent);
    box-shadow: 0 12px 36px rgba(45,212,191,0.13), 0 2px 12px rgba(99,102,241,0.10);
  }

  .experience-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 16px;
    margin-bottom: 8px;
  }

  .experience-date {
    color: var(--muted);
    font-size: 13px;
    font-family: var(--font-mono);
    white-space: nowrap;
  }

  .exp-desc {
    color: var(--muted);
    margin-bottom: 12px;
    font-size: 15px;
    line-height: 1.6;
  }

  .experience-meta {
    margin-top: 8px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
