---
import config from '../lib/config.json';

interface ExperienceEntry {
  title: string;
  company: string;
  companyLink?: string; // Added companyLink to the interface
  date: string;
  displayDate: string;
  description: string;
  skills: string[];
}

// Read experience from config JSON
const rawExperience = config.experience || [];
const settings = config.experienceSettings || { showMonth: true, dateFormat: 'short' };

const entries: ExperienceEntry[] = rawExperience.map((exp: any) => {
  let displayDate = exp.date;
  
  // Parse date and format for display
  if (exp.date) {
    // Handle YYYY-MM format
    if (/^\d{4}-\d{2}$/.test(exp.date)) {
      const d = new Date(exp.date + '-01');
      if (!isNaN(d.getTime())) {
        displayDate = settings.showMonth 
          ? d.toLocaleString('en', { month: 'short', year: 'numeric' })
          : d.getFullYear().toString();
      }
    } 
    // Handle YYYY format
    else if (/^\d{4}$/.test(exp.date)) {
      displayDate = settings.showMonth ? `Jan ${exp.date}` : exp.date;
    }
  }

  return {
    title: exp.title,
    company: exp.company,
    companyLink: exp.companyLink, // Added companyLink to the return object
    date: exp.date,
    displayDate,
    description: exp.description,
    skills: exp.skills || []
  };
});

// Sort by date descending (most recent first)
entries.sort((a, b) => {
  const parseDate = (d: string) => {
    if (/^\d{4}-\d{2}$/.test(d)) return new Date(d + '-01').getTime();
    if (/^\d{4}$/.test(d)) return new Date(`${d}-01-01`).getTime();
    return 0;
  };
  return parseDate(b.date) - parseDate(a.date);
});
---

<div class="timeline experience-timeline">
  {entries.map((entry, idx) => (
    <div class="experience-item" data-sr style={`--delay: ${idx * 100}ms`}>
      <div class="experience-content">
        <div class="experience-header">
          <h3 class="text-lg font-semibold">
            {entry.title}
            {entry.companyLink ? (
              <a
                class="company"
                href={entry.companyLink}
                target="_blank"
                rel="noopener noreferrer"
                style={`color: ${config.experienceSettings?.companyAccent || 'var(--accent, #4f8cff)'}; font-weight: 600; text-decoration: underline;`}
              >
                @ {entry.company}
              </a>
            ) : (
              <span
                class="company"
                style={`color: ${config.experienceSettings?.companyAccent || 'var(--accent, #4f8cff)'}; font-weight: 600;`}
              >
                @ {entry.company}
              </span>
            )}
          </h3>
          <div class="experience-date">{entry.displayDate}</div>
        </div>
        {entry.description && <p class="text-sm" style="color: var(--muted);">{entry.description}</p>}
        <div class="experience-meta">
          {entry.skills.map(t => (
            <span class="tech-tag">{t}</span>
          ))}
        </div>
      </div>
    </div>
  ))}
</div>

<style>
  .experience-timeline {
    position: relative;
    padding: 20px 16px 20px 16px;
  }

  /* Remove the central connecting line and the per-item bullets */
  .experience-timeline::before,
  .experience-item::before {
    display: none;
  }

  .experience-item {
    animation: slideIn 0.6s ease-out forwards;
    animation-delay: var(--delay, 0ms);
    opacity: 0;
    display: block;
    margin-bottom: 32px;
  }


  .experience-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 16px;
  }

  .company {
    margin-left: 8px;
    /* color and font-weight set inline for config-driven accent */
  }

  .experience-date {
    color: var(--muted);
    font-size: 13px;
    font-family: var(--font-mono);
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
</style>
