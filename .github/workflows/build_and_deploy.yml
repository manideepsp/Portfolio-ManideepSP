name: Build and Deploy
on:
  push:
    branches: [ main ]
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository (manual, safe copy)
        run: |
          set -euo pipefail
          echo "Cloning repository into a temporary directory..."
          TMPDIR=$(mktemp -d)
          git clone https://x-access-token:${{ secrets.GLOBAL_GITHUB_TOKEN }}@github.com/${{ github.repository }} "$TMPDIR/repo"
          cd "$TMPDIR/repo"
          # Ensure we're on the pushed branch if present
          git checkout "${{ github.ref_name }}" || true

          echo "Synchronizing files from temporary clone into the workspace"
          # Clean workspace (keep Github workspace metadata safe)
          rm -rf "$GITHUB_WORKSPACE"/* || true
          rsync -a --delete "$TMPDIR/repo/" "$GITHUB_WORKSPACE/"
          ls -la "$GITHUB_WORKSPACE" || true

      - name: Install Node 18
        run: |
          set -euo pipefail
          echo "Setting up Node 18..."
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Create CNAME if configured
        run: node .github/scripts/write-cname.mjs

      - name: Deploy to gh-pages (manual push)
        env:
          GITHUB_TOKEN_FOR_PUSH: ${{ secrets.GLOBAL_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "Preparing gh-pages branch"
          PUBLISH_DIR=dist
          if [ ! -d "$PUBLISH_DIR" ]; then
            echo "Publish directory $PUBLISH_DIR does not exist" >&2
            exit 1
          fi

          TMPDIR=$(mktemp -d)
          echo "Creating temporary git repo in $TMPDIR"
          cp -r $PUBLISH_DIR/* $TMPDIR || true
          cd $TMPDIR
          git init
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add --all
          git commit -m "chore: publish site to gh-pages [ci skip]"

          # Push to gh-pages branch using token
          REPO_URL="https://x-access-token:${GITHUB_TOKEN_FOR_PUSH}@github.com/${{ github.repository }}"
          git push --force $REPO_URL master:gh-pages
          echo "Published to gh-pages"